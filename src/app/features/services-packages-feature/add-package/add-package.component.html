<app-modal [(isOpen)]="showModal" [closeOnBackdrop]="false">
  <div class="flex flex-col h-[90vh] w-[90vw] max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex w-full justify-between items-center pt-0 p-4 border-b">
      <h2 class="text-lg font-semibold text-primary-500">
        {{ isEditing() ? "Editar" : "Agregar" }} Paquete
      </h2>
      <button
        class="hover:bg-primary-100 hover:rotate-90 text-primary-500 duration-300 ease-in-out w-10 h-10 flex items-center justify-center rounded-full"
        (click)="closeModal()"
      >
        <i class="pi pi-times"></i>
      </button>
    </div>

    <!-- Main Content with Scroll -->
    <div class="flex-1 overflow-y-auto p-4">
      <form
        [formGroup]="serviceForm"
        (ngSubmit)="onSubmit()"
        class="flex flex-col h-full"
      >
        <!-- Form Fields -->
        <div class="grid grid-cols-1 pb-4 md:grid-cols-2 gap-4">
          <app-input-form
            label="Nombre"
            formControlName="name"
            [required]="true"
          />

          <app-input-form
            label="Precio Unitario"
            type="text"
            formControlName="priceUnit"
            [required]="true"
            [isPositive]="true"
          />

          <app-select
            label="Tipo de Servicio"
            formControlName="type"
            [options]="serviceTypeOptions"
            [required]="true"
          />

          <app-input-form
            label="DescripciÃ³n"
            formControlName="description"
            [required]="true"
          />
        </div>

        <!-- Services Section -->
        <div class="flex-1 mt-4">
          <div class="flex justify-between mb-4">
            <div class="flex flex-col">
              <h3 class="text-lg font-semibold text-gray-700">
                Servicios Disponibles
              </h3>
              <p class="text-sm text-gray-500">
                Arrastra los servicios que deseas incluir en el paquete
              </p>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-500">
                Total: {{ sourceServices().length }}
              </span>
            </div>
          </div>

          <!-- PickList -->
          <p-pickList
            [source]="sourceServices()"
            [target]="targetServices()"
            [dragdrop]="true"
            [responsive]="true"
            [sourceStyle]="{ height: '24rem' }"
            [targetStyle]="{ height: '24rem' }"
            sourceHeader="Todos los Servicios"
            targetHeader="Servicios en Paquete"
            [showSourceControls]="false"
            [showTargetControls]="false"
            (onMoveToTarget)="updateSelectedServices()"
            (onMoveToSource)="updateSelectedServices()"
            styleClass="w-full"
          >
            <!-- Item Template -->
            <ng-template let-service pTemplate="item">
              <div
                class="flex flex-wrap items-center gap-3 w-full rounded-lg transition-colors"
              >
                <div class="flex-1 flex flex-col gap-1">
                  <div class="flex items-center gap-2">
                    <span class="font-medium text-gray-900">{{
                      service.name
                    }}</span>
                    <p-tag
                      [value]="service.type"
                      [severity]="service.status ? 'success' : 'danger'"
                      [rounded]="true"
                      class="text-xs"
                    ></p-tag>
                  </div>
                  <span class="text-sm text-gray-500 line-clamp-2">{{
                    service.description
                  }}</span>
                </div>
                <div class="flex flex-col items-end gap-2">
                  <span class="font-bold text-primary-500 text-SM">
                    {{ service.priceUnit | currency : "S/." }}
                  </span>
                  <span class="text-xs text-gray-400">
                    {{ service.createdAt | date : "dd/MM/yyyy" }}
                  </span>
                </div>
              </div>
            </ng-template>

            <ng-template pTemplate="sourceHeader">
              <div class="flex flex-col gap-2 p-3">
                <!-- Title and Counter Row -->
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-700"
                      >Todos los Servicios</span
                    >
                    <span
                      class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full"
                    >
                      {{ sourceServices().length }}
                    </span>
                  </div>
                  <div class="flex items-center gap-1.5 text-xs text-gray-500">
                    <i class="pi pi-info-circle text-gray-400 text-[12px]"></i>
                    <span>Arrastra para agregar</span>
                  </div>
                </div>

                <!-- Filter Row -->
                <div class="w-full">
                  <app-select
                    [options]="filterServiceByType"
                    [placeholder]="'Filtrar por tipo'"
                    styleClass="text-xs"
                  />
                </div>
              </div>
            </ng-template>

            <!-- Target Header -->
            <ng-template pTemplate="targetHeader">
              <div class="flex justify-between items-center p-3">
                <span class="font-medium"
                  >Servicios Seleccionados ({{ targetServices().length }})</span
                >
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-primary-500">
                    Total: {{ calculateTotalPrice() | currency : "PEN" }}
                  </span>
                </div>
              </div>
            </ng-template>
          </p-pickList>

          <!-- Paginator -->
          <div class="mt-4">
            <p-paginator
              [rows]="pageSize"
              [totalRecords]="totalRecords"
              [rowsPerPageOptions]="[5, 10, 20]"
              (onPageChange)="onPageChange($event)"
              [first]="(currentPage - 1) * pageSize"
            ></p-paginator>
          </div>
        </div>
      </form>
    </div>

    <!-- Footer Actions -->
    <div class="p-4 border-t mt-auto">
      <div class="flex justify-end gap-x-4">
        <button
          type="button"
          class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 duration-300 ease-in-out"
          (click)="closeModal()"
        >
          Cancelar
        </button>
        <app-button
          type="submit"
          bgColor="bg-primary-500"
          moreClasses="py-2 px-6"
          [text]="
            isSubmitting()
              ? isEditing()
                ? 'Actualizando...'
                : 'Guardando...'
              : isEditing()
              ? 'Actualizar'
              : 'Guardar'
          "
          [icon]="isSubmitting() ? 'pi pi-spin pi-spinner' : ''"
          [disabled]="!serviceForm.valid || isSubmitting()"
        />
      </div>
    </div>
  </div>
</app-modal>

<p-toast [life]="3000" [baseZIndex]="100000"></p-toast>
